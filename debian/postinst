#!/bin/sh
set -e

echo "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Kubsh..."

# 1. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è VFS —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
echo "–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /opt/users..."
mkdir -p /opt/users
chmod 755 /opt/users
chown root:root /opt/users

# 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–ª—è FUSE
echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–ª—è FUSE..."
if [ -e /dev/fuse ]; then
    chmod 666 /dev/fuse || true
    echo "–ü—Ä–∞–≤–∞ –Ω–∞ /dev/fuse —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: $(ls -la /dev/fuse)"
else
    echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: /dev/fuse –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –ø–∞–∫–µ—Ç–∞."
    echo "–ü—Ä–∞–≤–∞ –±—É–¥—É—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏."
fi

# 3. –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è FUSE
echo "–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è FUSE..."
modprobe fuse || true
echo "–ú–æ–¥—É–ª—å FUSE –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω"

# 4. –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–µ—Ä—Å–∏—è–º–∏ libfuse3
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ FUSE..."
# –ù–∞—Ö–æ–¥–∏–º —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ libfuse3.so.4
LIBFUSE_PATH=$(find /lib /usr/lib -name "libfuse3.so.4*" 2>/dev/null | head -1)

if [ -n "$LIBFUSE_PATH" ]; then
    echo "–ù–∞–π–¥–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ FUSE: $LIBFUSE_PATH"
    
    # –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    LIB_DIR=$(dirname "$LIBFUSE_PATH")
    
    # –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    if [ ! -e "$LIB_DIR/libfuse3.so.3" ]; then
        echo "–°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏ libfuse3.so.3 -> libfuse3.so.4"
        ln -sf "$(basename "$LIBFUSE_PATH")" "$LIB_DIR/libfuse3.so.3" || true
    fi
    
    # –°–æ–∑–¥–∞–µ–º –æ–±—â—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ª–∏–Ω–∫–æ–≤—â–∏–∫–∞
    if [ ! -e "$LIB_DIR/libfuse3.so" ]; then
        echo "–°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏ libfuse3.so -> libfuse3.so.4"
        ln -sf "$(basename "$LIBFUSE_PATH")" "$LIB_DIR/libfuse3.so" || true
    fi
    
    echo "–°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ —Å–æ–∑–¥–∞–Ω—ã:"
    ls -la "$LIB_DIR"/libfuse3.so* 2>/dev/null || echo "–°—Å—ã–ª–∫–∏ —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
    echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: libfuse3.so.4 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –ø–∞–∫–µ—Ç–∞."
    echo "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –±—É–¥—É—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏."
fi

# 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫..."
ldconfig || true

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Kubsh..."
if command -v kubsh >/dev/null 2>&1; then
    echo "‚úÖ kubsh –Ω–∞–π–¥–µ–Ω –≤ PATH: $(which kubsh)"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π kubsh:"
    ldd $(which kubsh) | grep -i fuse || echo "FUSE –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
    
    # –ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ kubsh:"
    kubsh --version 2>&1 || echo "kubsh –≤–µ—Ä—Å–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è"
    echo "‚úÖ Kubsh —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
else
    echo "‚ùå –í–Ω–∏–º–∞–Ω–∏–µ: kubsh –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ PATH"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–∞ –∏ –ø—É—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
    exit 1
fi

echo ""
echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Kubsh –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "–¢–æ—á–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è VFS: /opt/users"
echo "–î–ª—è –∑–∞–ø—É—Å–∫–∞ shell: kubsh"
echo ""

exit 0

