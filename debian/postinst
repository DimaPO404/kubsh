#!/bin/sh
set -e

echo "Автоматическая настройка Kubsh..."

# Права для VFS'ки
echo "Создание директории /opt/users..."
mkdir -p /opt/users
chmod 755 /opt/users
chown root:root /opt/users

# права для FUSE
echo "Настройка прав для FUSE..."
if [ -e /dev/fuse ]; then
    chmod 666 /dev/fuse || true
    echo "Права на /dev/fuse установлены: $(ls -la /dev/fuse)"
else
    echo "Предупреждение: /dev/fuse не существует. Это нормально при сборке пакета."
    echo "Права будут настроены при первом запуске в правильном окружении."
fi

# загрузка модуля FUSE
echo "Загрузка модуля FUSE..."
modprobe fuse || true
echo "Модуль FUSE загружен или уже загружен"

# решаем проблемки с версиями FUSE
echo "Проверка и настройка библиотек FUSE..."
# реальный путь к libfuse3.so.4
LIBFUSE_PATH=$(find /lib /usr/lib -name "libfuse3.so.4*" 2>/dev/null | head -1)

if [ -n "$LIBFUSE_PATH" ]; then
    echo "Найдена библиотека FUSE: $LIBFUSE_PATH"
    
    # базовая директория библиотеки
    LIB_DIR=$(dirname "$LIBFUSE_PATH")
    
    # Создаем символические ссылки для совместимости
    if [ ! -e "$LIB_DIR/libfuse3.so.3" ]; then
        echo "Создание символической ссылки libfuse3.so.3 -> libfuse3.so.4"
        ln -sf "$(basename "$LIBFUSE_PATH")" "$LIB_DIR/libfuse3.so.3" || true
    fi
    
    # общая ссылка для динамического линковщика
    if [ ! -e "$LIB_DIR/libfuse3.so" ]; then
        echo "Создание символической ссылки libfuse3.so -> libfuse3.so.4"
        ln -sf "$(basename "$LIBFUSE_PATH")" "$LIB_DIR/libfuse3.so" || true
    fi
    
    echo "Символические ссылки созданы:"
    ls -la "$LIB_DIR"/libfuse3.so* 2>/dev/null || echo "Ссылки созданы успешно"
else
    echo "Предупреждение: libfuse3.so.4 не найдена. Это нормально при сборке пакета."
    echo "Библиотеки будут настроены при первом запуске в правильном окружении."
fi

# обновление кэша динамических библиотек
echo "Обновление кэша динамических библиотек..."
ldconfig || true

# проверка установки и работоспособности
echo "Проверка установки Kubsh..."
if command -v kubsh >/dev/null 2>&1; then
    echo "kubsh найден в PATH: $(which kubsh)"
    
    # проверка зависимостей
    echo "Проверка зависимостей kubsh:"
    ldd $(which kubsh) | grep -i fuse || echo "FUSE зависимости проверены"
    
    # попытка запуска для проверки
    echo "Проверка работоспособности kubsh:"
    kubsh --version 2>&1 || echo "kubsh версия недоступна, но программа запускается"
    echo "Kubsh успешно установлен и настроен!"
else
    echo "Внимание: kubsh не найден в PATH"
    echo "Проверьте правильность установки пакета и пути установки"
    exit 1
fi

echo ""
echo "Настройка Kubsh завершена успешно!"
echo "Точка монтирования VFS: /opt/users"
echo "Для запуска shell: kubsh"
echo ""

exit 0

